<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abdo Rumma | Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --main: #6f42c1; --gold: #ffc107; --dark: #1a1a1a;
            --bg: #f8f9fa; --white: #ffffff; --red: #ff4757;
            --whatsapp: #25D366; --facebook: #1877f2; --success-green: #2ed573;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--dark); overflow-x: hidden; padding-bottom: 80px; }

        /* === 1. Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„ÙƒØ§Ù…Ù„) === */
        .auth-container { position: fixed; inset: 0; background: var(--white); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .brand-box { margin-bottom: 30px; display: flex; align-items: center; gap: 8px; transform: scale(1.2); }
        .brand-text { font-weight: 900; font-size: 24px; color: var(--dark); }
        .verified-check { color: black; font-size: 20px; }
        .auth-card { width: 100%; max-width: 340px; }
        .input-group { margin-bottom: 5px; position: relative; width: 100%; text-align: right; }
        .input-field { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #eee; background: #f9f9f9; font-weight: 700; outline: none; transition: 0.3s; font-size: 14px; margin-bottom: 5px;}
        .input-field:focus { border-color: var(--main); background: #fff; }
        .input-error { border-color: var(--red) !important; background: #fff0f0 !important; }
        .error-msg { color: var(--red); font-size: 12px; font-weight: 800; margin-top: 5px; margin-bottom: 10px; display: none; }
        .btn-auth { width: 100%; padding: 16px; background: var(--dark); color: var(--gold); border: none; border-radius: 15px; font-weight: 900; font-size: 16px; cursor: pointer; margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.3s; }

        /* Ù„ÙˆØ¯Ø± Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
        .inner-loader { display: none; margin-top: 15px; text-align: center; }
        .inner-spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top: 3px solid var(--main); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
        .loading-text { font-size: 14px; font-weight: 700; color: #666; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ÙØ´Ù„ */
        .overlay-anim { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 10002; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .checkmark-wrapper { width: 100px; height: 100px; }
        .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: var(--success-green); fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark { width: 100px; height: 100px; border-radius: 50%; display: block; stroke-width: 2; stroke: var(--white); stroke-miterlimit: 10; margin: 10% auto; box-shadow: inset 0px 0px 0px var(--success-green); animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        .cross__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: var(--red); fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .crossmark { width: 100px; height: 100px; border-radius: 50%; display: block; stroke-width: 2; stroke: var(--white); stroke-miterlimit: 10; margin: 10% auto; box-shadow: inset 0px 0px 0px var(--red); animation: fillRed .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .cross__path { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 50px var(--success-green); } }
        @keyframes fillRed { 100% { box-shadow: inset 0px 0px 0px 50px var(--red); } }

        /* === Ø§Ù„Ù‡ÙŠØ¯Ø± (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ù€ Exit) === */
        .header { 
            position: fixed; top: 0; left: 0; width: 100%; background: var(--white); z-index: 1000; padding: 10px 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; 
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .logout-btn { 
            background: #000; color: white; border: none; padding: 5px 12px; 
            border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; 
        }
        
        .notif-wrapper { position: relative; cursor: pointer; margin-right: 10px; }
        .notif-icon { font-size: 22px; color: var(--dark); }
        .notif-badge { 
            position: absolute; top: -5px; right: -5px; background: var(--red); 
            color: white; width: 15px; height: 15px; font-size: 10px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            display: none;
        }

        .search-box { position: relative; width: 100%; }
        .search-input { width: 100%; padding: 10px 35px 10px 15px; border-radius: 25px; border: 1px solid #ddd; background: #f0f2f5; font-weight: 700; outline: none; }
        .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888; font-size: 14px; }

        /* === Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª === */
        .notif-panel {
            position: fixed; top: 80px; right: 15px; left: 15px; background: white;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 998;
            padding: 15px; display: none; max-height: 300px; overflow-y: auto;
        }
        .notif-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .notif-item:hover { background: #f9f9f9; }
        .notif-item.new { background: #f0f7ff; }

        /* === Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„ÙƒØ±ÙˆØª === */
        .page-section { display: none; padding-top: 130px; min-height: 80vh; }
        .active-page { display: block; }

        .card { background: white; border-radius: 15px; overflow: hidden; margin: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); animation: fadeInUp 0.5s ease; scroll-margin-top: 140px; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-info { padding: 15px; text-align: right; }
        .type-tag { background: var(--dark); color: var(--gold); padding: 4px 12px; border-radius: 15px; font-size: 11px; display: inline-block; margin-bottom: 5px; }
        .desc-text { font-size: 14px; color: #555; margin-bottom: 5px; word-wrap: break-word; }
        .price-tag { font-size: 20px; color: var(--main); font-weight: 900; display: block; }
        .timer-tag { font-size: 12px; color: var(--red); font-family: sans-serif; font-weight: bold; background: #fff0f0; padding: 3px 8px; border-radius: 5px; display: inline-block; margin-top: 5px; }

        .btn-contact { width: 100%; padding: 12px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 900; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; transition: 0.3s; }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 5px; }
        .nav-item.active { color: var(--main); transform: translateY(-5px); }

        .my-account-header { text-align: center; padding: 20px; background: white; border-radius: 15px; margin: 15px; }
        .add-btn-large { background: var(--main); color: white; width: 100%; padding: 15px; border-radius: 15px; text-align: center; font-size: 18px; font-weight: bold; margin-top: 20px; display: block; cursor: pointer; box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 90%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; }
        .contact-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f4f4f9; border-radius: 10px; margin-bottom: 8px; text-align: right; }
        .c-icon { font-size: 24px; }
        .c-link { color: #1877f2; text-decoration: none; word-break: break-all; font-size: 13px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="success-anim" class="overlay-anim">
        <div class="checkmark-wrapper"><svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>
        <h3 style="margin-top:20px; font-weight:900; color:var(--dark);">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
    </div>
    <div id="fail-anim" class="overlay-anim">
        <div class="checkmark-wrapper"><svg class="crossmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="cross__circle" cx="26" cy="26" r="25" fill="none"/><path class="cross__path" fill="none" d="M16 16 36 36 M36 16 16 36" stroke="white" stroke-width="2"/></svg></div>
        <h3 style="margin-top:20px; font-weight:900; color:var(--red);">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!</h3>
    </div>

    <div id="register-view" class="auth-container">
        <div class="brand-box"><span class="brand-text">Abdo Rumma</span><i class="fas fa-check-circle verified-check"></i></div>
        <div class="auth-card">
            <h3 style="margin-bottom:20px; font-weight:900;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="input-group"><input type="text" id="reg-user" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></div>
            <div class="input-group"><input type="password" id="reg-pass" class="input-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
            <div class="input-group"><input type="number" id="reg-phone" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨"></div>
            <div class="input-group"><input type="url" id="reg-fb" class="input-field" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ"></div>
            <button id="reg-btn" class="btn-auth" onclick="processRegister()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            <div id="inner-loading" class="inner-loader"><div class="inner-spinner"></div><div class="loading-text">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div></div>
            <p style="margin-top:15px; font-weight:700; font-size:13px;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <span onclick="showLogin()" style="color:var(--main); cursor:pointer;">Ø¯Ø®ÙˆÙ„</span></p>
        </div>
    </div>

    <div id="login-view" class="auth-container" style="display:none;">
        <div class="brand-box"><span class="brand-text">Abdo Rumma</span><i class="fas fa-check-circle verified-check"></i></div>
        <div class="auth-card">
            <h3 style="margin-bottom:20px; font-weight:900;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <div class="input-group"><input type="text" id="log-user" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></div>
            <div class="input-group"><input type="password" id="log-pass" class="input-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
            <button class="btn-auth" onclick="processLogin()">Ø¯Ø®ÙˆÙ„</button>
            <p style="margin-top:15px; font-weight:700; font-size:13px;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <span onclick="showRegister()" style="color:var(--main); cursor:pointer;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span></p>
        </div>
    </div>

    <div class="header">
        <div class="header-top">
            <button class="logout-btn" onclick="logout()">Exit <i class="fas fa-sign-out-alt"></i></button>
            
            <div class="brand-text" style="font-size:18px;">Ø§Ù„Ù…ØªØ¬Ø±</div>
            <div class="notif-wrapper" onclick="toggleNotif()">
                <i class="far fa-bell notif-icon"></i>
                <div class="notif-badge" id="n-badge">0</div>
            </div>
        </div>
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="number" id="search-input" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø³Ø¹Ø±..." oninput="handleSearch()">
        </div>
    </div>

    <div id="notif-panel" class="notif-panel">
        <h4 style="margin:0 0 10px 0; font-size:14px;">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
        <div id="notif-list">
            <p style="color:#777; font-size:12px; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>
        </div>
    </div>

    <div id="home-page" class="page-section active-page">
        <div id="products-grid"></div>
        <div id="empty-msg" style="display:none; text-align:center; margin-top:50px; color:#888;">
            <i class="far fa-folder-open" style="font-size:50px; color:#ddd;"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</p>
        </div>
    </div>

    <div id="my-page" class="page-section">
        <div class="my-account-header">
            <h3>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h3>
            <p style="color:#666; font-size:14px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø­ÙÙˆØ¸Ø© ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù†Ø´Ø±</p>
            <div class="add-btn-large" onclick="document.getElementById('add-modal').style.display='flex'">
                <i class="fas fa-plus-circle"></i> Ù†Ø´Ø± Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home', this)"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="switchPage('my', this)"><i class="fas fa-user-tag"></i> Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</div>
    </div>

    <div id="add-modal" class="modal-overlay">
        <div class="modal-box" style="text-align: right;">
            <h3 style="text-align:center; margin-bottom:15px;">Ø¨ÙŠØ¹ Ø­Ø³Ø§Ø¨</h3>
            <p style="font-size:11px; color:#666; text-align:center; margin-bottom:15px;">Ø³ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
            
            <label style="font-size:12px; font-weight:bold;">ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input type="file" id="p-img" accept="image/*" class="input-field" style="padding:10px;">
            <label style="font-size:12px; font-weight:bold;">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¨Ø·</label>
            <select id="p-type" class="input-field">
                <option value="Konami Only">ÙƒÙˆÙ†Ø§Ù…ÙŠ ÙÙ‚Ø· (Konami ID)</option>
                <option value="Google Guaranteed">Ø¬ÙˆØ¬Ù„ Ø¨Ø¶Ù…Ø§Ù† (Google)</option>
            </select>
            <label style="font-size:12px; font-weight:bold;">ÙˆØµÙ (50 Ø­Ø±Ù)</label>
            <input type="text" id="p-desc" class="input-field" maxlength="50" placeholder="ÙˆØµÙ Ø§Ù„Ø­Ø³Ø§Ø¨">
            <label style="font-size:12px; font-weight:bold;">Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
            <input type="number" id="p-price" class="input-field" placeholder="Ø§Ù„Ø³Ø¹Ø±">

            <button class="btn-auth" onclick="publish()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            <button class="btn-auth" style="background:#eee; color:#333; margin-top:5px;" onclick="document.getElementById('add-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="success-modal" class="modal-overlay" style="background:white;">
        <div style="text-align:center;">
             <div class="checkmark-wrapper" style="margin:0 auto;"><svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>
            <h2 style="color:#2ed573; font-weight:900; margin-top:20px;">ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!</h2>
        </div>
    </div>

    <div id="contact-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:20px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹</h3>
            <div class="contact-row"><i class="fab fa-whatsapp c-icon" style="color:var(--whatsapp);"></i><div id="c-phone" style="font-weight:bold; font-size:18px;"></div></div>
            <div class="contact-row" id="fb-row"><i class="fab fa-facebook c-icon" style="color:var(--facebook);"></i><a id="c-fb" href="#" target="_blank" class="c-link"></a></div>
            <button class="btn-auth" style="background:#eee; color:#333;" onclick="document.getElementById('contact-modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://efqqyogkowffqbozgard.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Vzf_KFIeBiCJR9QEZrSn0Q_wq3VMYZB';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        let allProducts = [];
        const EXPIRY_DAYS = 5;
        let localUsers = JSON.parse(localStorage.getItem('ar_users')) || [];
        let notifications = [];

        // === 1. Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ===
        function processRegister() {
            const user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value;
            const phone = document.getElementById('reg-phone').value;
            const fb = document.getElementById('reg-fb').value;

            if(!user || !pass || !phone || !fb) return alert('Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

            document.getElementById('reg-btn').style.display = 'none';
            document.getElementById('inner-loading').style.display = 'block';

            setTimeout(() => {
                const phoneRegex = /^01[0125]\d{8}$/; 
                if(!phoneRegex.test(phone)) { showFail(); return; }

                localUsers.push({ user, pass, phone, fb });
                localStorage.setItem('ar_users', JSON.stringify(localUsers));

                document.getElementById('inner-loading').style.display = 'none';
                document.getElementById('success-anim').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('success-anim').style.display = 'none';
                    showLogin();
                    document.getElementById('reg-btn').style.display = 'block';
                }, 2000);
            }, 2000);
        }

        function showFail() {
            document.getElementById('inner-loading').style.display = 'none';
            document.getElementById('fail-anim').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('fail-anim').style.display = 'none';
                document.getElementById('reg-btn').style.display = 'block';
            }, 2000);
        }

        // === 2. Ø§Ù„Ø¯Ø®ÙˆÙ„ ===
        function processLogin() {
            const user = document.getElementById('log-user').value;
            const pass = document.getElementById('log-pass').value;
            const found = localUsers.find(u => u.user === user && u.pass === pass);

            if(found) {
                localStorage.setItem('currentUser', user);
                localStorage.setItem('currentPhone', found.phone);
                localStorage.setItem('currentFB', found.fb);
                initApp();
            } else { alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©'); }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload(); 
        }

        // === 3. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
        function initApp() {
            document.getElementById('register-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'none';
            fetchProducts();
            setInterval(fetchProducts, 60000); // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        }

        // === 4. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===
        async function fetchProducts() {
            const { data } = await db.from('products').select('*').order('created_at', { ascending: false });
            if(!data) return;

            const now = new Date();
            allProducts = data.filter(p => {
                const created = new Date(p.created_at);
                const diffDays = Math.ceil(Math.abs(now - created) / (1000 * 60 * 60 * 24)); 
                return diffDays <= EXPIRY_DAYS;
            });

            checkNotifications(allProducts); // ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            renderProducts(allProducts);
        }

        // === Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ===
        function checkNotifications(products) {
            const lastId = parseInt(localStorage.getItem('last_prod_id') || 0);
            const myPhone = localStorage.getItem('currentPhone');
            const notifList = document.getElementById('notif-list');
            const badge = document.getElementById('n-badge');
            
            let newNotifsHTML = '';
            let count = 0;

            // 1. ÙØ­Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            if(products.length > 0 && products[0].id > lastId) {
                // Ù„Ø¯ÙŠÙ†Ø§ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                const newP = products[0];
                if(newP.phone !== myPhone) { // Ù„ÙŠØ³ Ø£Ù†Ø§ Ù…Ù† Ù†Ø´Ø±Ù‡
                    count++;
                    newNotifsHTML += `
                        <div class="notif-item new" onclick="goToProduct(${newP.id})">
                            <i class="fas fa-plus-circle" style="color:var(--success-green);"></i>
                            <div>
                                <b>Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ØªÙ… Ù†Ø´Ø±Ù‡!</b><br>
                                Ù†ÙˆØ¹: ${newP.type} - Ø³Ø¹Ø±: ${newP.price}
                            </div>
                        </div>`;
                }
                localStorage.setItem('last_prod_id', newP.id);
            }
            
            if(count > 0) {
                badge.style.display = 'flex';
                badge.innerText = count;
                notifList.innerHTML = newNotifsHTML + notifList.innerHTML;
            }
        }

        function toggleNotif() {
            const p = document.getElementById('notif-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
            document.getElementById('n-badge').style.display = 'none'; // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯
        }

        function goToProduct(id) {
            // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            document.getElementById('notif-panel').style.display = 'none';
            // Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            switchPage('home', document.querySelector('.nav-item'));
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙƒØ§Ø±Øª
            setTimeout(() => {
                const el = document.getElementById('card-'+id);
                if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
            }, 300);
        }

        // === 5. Ø§Ù„Ø¹Ø±Ø¶ ===
        function renderProducts(products) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            if(products.length === 0) { document.getElementById('empty-msg').style.display = 'block'; return; }
            else { document.getElementById('empty-msg').style.display = 'none'; }

            products.forEach(p => {
                const imgSrc = p.image ? p.image : 'https://via.placeholder.com/400x200';
                const timeLeft = getTimeLeft(p.created_at);
                // Ø£Ø¶ÙÙ†Ø§ id Ù„Ù„ÙƒØ§Ø±Øª Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù†Ø±ÙˆØ­Ù„Ù‡
                grid.innerHTML += `
                    <div class="card" id="card-${p.id}"> 
                        <img src="${imgSrc}">
                        <div class="card-info">
                            <span class="type-tag">${p.type}</span>
                            <div class="price-tag">${p.price} Ø¬.Ù…</div>
                            <div class="desc-text">${p.desc}</div>
                            <div class="timer-tag"><i class="far fa-clock"></i> ${timeLeft}</div>
                            <button class="btn-contact" onclick="openContact('${p.phone}', '${p.fb || ''}')">
                                <i class="fas fa-comment-dots"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹
                            </button>
                        </div>
                    </div>`;
            });
        }

        // === 6. Ø§Ù„Ù†Ø´Ø± ===
        async function publish() {
            const file = document.getElementById('p-img').files[0];
            const type = document.getElementById('p-type').value;
            const desc = document.getElementById('p-desc').value;
            const price = document.getElementById('p-price').value;
            const phone = localStorage.getItem('currentPhone'); 
            const fb = localStorage.getItem('currentFB');

            if(!price || !desc) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            const prodData = { type, desc, price, phone, fb, image: "" };

            const save = async (d) => {
                const { error } = await db.from('products').insert([d]);
                if(!error) {
                    document.getElementById('add-modal').style.display='none';
                    document.getElementById('success-modal').style.display='flex';
                    setTimeout(() => {
                        document.getElementById('success-modal').style.display='none';
                        fetchProducts();
                    }, 2500);
                }
            };

            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => { prodData.image = e.target.result; save(prodData); };
                reader.readAsDataURL(file);
            } else { save(prodData); }
        }

        // === Ø£Ø¯ÙˆØ§Øª ===
        function handleSearch() {
            const q = document.getElementById('search-input').value;
            if(!q) renderProducts(allProducts);
            else renderProducts(allProducts.filter(p => p.price == q));
        }
        function getTimeLeft(d) {
            const expiry = new Date(new Date(d).getTime() + (EXPIRY_DAYS * 86400000));
            const diff = expiry - new Date();
            if(diff <= 0) return "Ù…Ù†ØªÙ‡ÙŠ";
            return `${Math.floor(diff/86400000)}d ${Math.floor((diff%86400000)/3600000)}h left`;
        }
        function openContact(phone, fb) {
            document.getElementById('contact-modal').style.display = 'flex';
            document.getElementById('c-phone').innerText = phone;
            const fbRow = document.getElementById('fb-row');
            if(fb && fb.length > 5) {
                fbRow.style.display = 'flex';
                document.getElementById('c-fb').href = fb;
                document.getElementById('c-fb').innerText = fb;
            } else fbRow.style.display = 'none';
        }
        function switchPage(pageId, btn) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-page'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(pageId === 'home') document.getElementById('home-page').classList.add('active-page');
            if(pageId === 'my') document.getElementById('my-page').classList.add('active-page');
            btn.classList.add('active');
        }
        function showRegister() { document.getElementById('login-view').style.display='none'; document.getElementById('register-view').style.display='flex'; }
        function showLogin() { document.getElementById('register-view').style.display='none'; document.getElementById('login-view').style.display='flex'; }

        if(localStorage.getItem('currentUser')) initApp();
        else showRegister();
    </script>
</body>
</html>
